server {
	listen 443 ssl;
	server_name www.dev.org;
	ssl_certificate /etc/nginx/www.dev.org.crt;
	ssl_certificate_key /etc/nginx/www.dev.org.key;

	modsecurity on;
	modsecurity_rules_file /etc/nginx/modsec/main.conf;
	proxy_buffer_size 128k;
    	proxy_buffers 4 256k;
    	proxy_busy_buffers_size 256k;
	large_client_header_buffers 4 16k;

	location = / {
		auth_request off;
		proxy_pass https://myapp;
		proxy_ssl_verify on;
		proxy_ssl_trusted_certificate /usr/share/easy-rsa/pki/ca.crt;
		proxy_ssl_verify_depth 1;
		proxy_ssl_name internal-web;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		limit_req zone=one burst=5 nodelay;
		limit_req_dry_run on;
		proxy_cache my_cache;
	}
	location ~ ^/(index.html|login.html|logout.html|favicon.ico)$ {
		auth_request off;
		proxy_pass https://myapp;
		proxy_ssl_verify on;
		proxy_ssl_trusted_certificate /usr/share/easy-rsa/pki/ca.crt;
		proxy_ssl_verify_depth 1;
		proxy_ssl_name internal-web;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		limit_req zone=one burst=5 nodelay;
		limit_req_dry_run on;
		proxy_cache my_cache;
	}
	location ~ ^/(css|js|assets)/ {
		auth_request off;
		proxy_pass https://myapp;
		proxy_ssl_verify on;
		proxy_ssl_trusted_certificate /usr/share/easy-rsa/pki/ca.crt;
		proxy_ssl_verify_depth 1;
		proxy_ssl_name internal-web;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		limit_req zone=one burst=5 nodelay;
		limit_req_dry_run on;
		proxy_cache my_cache;
	}

	location / {
		auth_request /oauth2/auth;
		error_page 401 = /oauth2/start;
		proxy_pass https://myapp;
		proxy_ssl_verify on;
		proxy_ssl_trusted_certificate /usr/share/easy-rsa/pki/ca.crt;
		proxy_ssl_verify_depth 1;
		proxy_ssl_name internal-web;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		limit_req zone=one burst=5 nodelay;
		limit_req_dry_run on;
		proxy_cache my_cache;
	}
	location /oauth2/ {
        	proxy_pass http://127.0.0.1:4180;
	        proxy_set_header Host $host;
        	proxy_set_header X-Real-IP $remote_addr;
	        proxy_set_header X-Scheme $scheme;
        	proxy_set_header X-Auth-Request-Redirect $request_uri;
	}
	location = /oauth2/auth {
	        proxy_pass http://127.0.0.1:4180;
        	proxy_set_header Host $host;
	        proxy_set_header X-Real-IP $remote_addr;
        	proxy_set_header X-Scheme $scheme;
		proxy_set_header Content-Length "";
     	   	proxy_pass_request_body off;
	}
	location = /oauth2/userinfo {
		proxy_pass http://127.0.0.1:4180; 
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		
		auth_request off;
	}
	location /ollama/ {
		auth_request /oauth2/auth;
		proxy_pass https://myapp;
		proxy_ssl_verify on;
		proxy_ssl_trusted_certificate /usr/share/easy-rsa/pki/ca.crt;
		proxy_ssl_verify_depth 1;
		proxy_ssl_name internal-web;
		proxy_buffering off;
		proxy_read_timeout 300s;
		proxy_connect_timeout 300s;
		proxy_send_timeout 300s;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		limit_req zone=ollama_limit burst=2 nodelay;
		limit_req_status 429;
	}
}


server {
	listen 443 ssl;
	server_name auth.dev.org;
	ssl_certificate /etc/nginx/auth.dev.org.crt; 
	ssl_certificate_key /etc/nginx/auth.dev.org.key;

	location = /{
		return 404;
	}
	location = /auth {
		allow 127.0.0.1;
		return 404;
	}
	location = /auth/ {
		return 404;
	}
	
	location /auth {
        	proxy_pass http://127.0.0.1:8080; 
        
       		proxy_set_header Host $host;
        	proxy_set_header X-Real-IP $remote_addr;
        	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        	proxy_set_header X-Forwarded-Proto https;
    	}
}
