name: Discord Notifier

on:
  push:
    branches: [main, webservera, webserverb]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq if missing
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Send message to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          PUSHER: ${{ github.event.pusher.name || github.actor }}
          MSG: ${{ github.event.head_commit.message }}
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          if [ -z "${WEBHOOK:-}" ]; then
            echo "DISCORD_WEBHOOK secret is missing or not accessible to this run."
            echo "Check Settings â†’ Secrets and variables â†’ Actions â†’ Secrets."
            exit 1
          fi

          MSG="${MSG:-No commit message}"
          COMMIT_URL="https://github.com/$REPO/commit/$SHA"

          payload=$(jq -n -c \
            --arg repo "$REPO" \
            --arg branch "$BRANCH" \
            --arg pusher "$PUSHER" \
            --arg msg "$MSG" \
            --arg url "$COMMIT_URL" \
            '{content: "ðŸ”” Repo: \($repo)\nâ€¢ Branch: \($branch)\nâ€¢ By: \($pusher)\nâ€¢ Message: \($msg)\nâ€¢ Commit: \($url)"}')

          # ask Discord to return a response for easier debugging
          URL="$WEBHOOK"
          case "$URL" in
            *\?*) URL="$URL&wait=true" ;;
            *)    URL="$URL?wait=true" ;;
          esac

          curl -fsS -H "Content-Type: application/json" -d "$payload" "$URL"